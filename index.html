<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MeineMOVE – Gelenkbewegung: privat, offline, cloudfrei</title>
<style>
:root { --bg:#0b1016; --card:#121820; --muted:#8aa0b2; --text:#eaf2f8; --accent:#50c878; --danger:#ff6b6b; --warn:#ffc857; }
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1016,#0e141c);color:var(--text);}
.wrap{max-width:960px;margin:0 auto;padding:16px;}
h1{font-size:22px;margin:0 0 16px;}
.card{background:var(--card);border-radius:18px;padding:16px;margin-bottom:14px;box-shadow:0 6px 24px rgba(0,0,0,.28);}
label{display:block;margin:8px 0 4px;color:var(--muted);}
input, select, button{width:100%;padding:10px;border-radius:10px;border:1px solid #203040;background:#0b1118;color:var(--text);}
button{cursor:pointer;}
button.primary{background:var(--accent);color:#072d19;font-weight:700;}
button.danger{background:var(--danger);color:#320a0a;}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.right{margin-left:auto;}
.hint{font-size:12px;color:var(--muted);}
.toast{position:fixed;left:50%;bottom:20px;padding:10px 14px;background:#0f1b23;border-radius:10px;transform:translateX(-50%);display:none;z-index:999;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
th,td{border:1px solid #203040;padding:4px;text-align:center;}
th{background:#121820;}
</style>
</head>
<body>
<div class="wrap">
  <h1>MeineMOVE – Gelenkbewegung: privat, offline und cloudfrei</h1>

  <div class="card">
    <strong>Sensors & Joint Control</strong>
    <div class="flex">
      <button id="btnEnable" class="primary">Enable Sensors</button>
      <button id="btnSetZero">Set Zero</button>
    </div>
    <label>Joint / Movement</label>
    <select id="jointSelect">
      <option>Shoulder</option>
      <option>Elbow</option>
      <option>Knee</option>
    </select>
    <div class="flex">
      <div>Angle (°): <span id="angleDisplay">0.0</span></div>
      <div>Max (°): <span id="maxDisplay">0.0</span></div>
      <div>Min (°): <span id="minDisplay">0.0</span></div>
    </div>
  </div>

  <div class="card">
    <strong>Continuous Capture Mode</strong>
    <label>Auto-Record Interval (seconds)</label>
    <input type="number" id="autoInterval" min="1" value="5">
    <div class="flex">
      <button id="btnStart" class="primary">Start Session</button>
      <button id="btnStop" class="danger">Stop Session</button>
    </div>
  </div>

  <div class="card">
    <strong>Export & Copy Records</strong>
    <div class="flex">
      <button id="btnExport">Export CSV</button>
      <button id="btnCopy" class="primary">Copy to Clipboard</button>
    </div>
    <div class="hint">Copy all records in CSV format to clipboard.</div>
    <table id="recordsTable">
      <thead><tr><th>Time</th><th>Joint</th><th>Angle°</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <p class="hint">
    Disclaimer: Screening, exercise guidance, and documentation support. Does not replace clinical judgment.<br>
    Contact: Moustafa Mohammed Elsayed Ali | <a href="mailto:mostischmidbauer@web.de">mostischmidbauer@web.de</a>
  </p>
</div>

<div class="toast" id="toast"></div>

<script>
let zeroOffset = 0;
let currentAngle = 0;
let maxAngle = -Infinity;
let minAngle = Infinity;
let sessionInterval = null;
let records = [];

// Load saved records
if(localStorage.getItem('records')) records = JSON.parse(localStorage.getItem('records'));
updateTable();

function showToast(msg){
  const toast = document.getElementById('toast');
  toast.innerText = msg;
  toast.style.display = 'block';
  setTimeout(()=>toast.style.display='none',2000);
}

// Sensor enable
document.getElementById('btnEnable').addEventListener('click', async ()=>{
  if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
    let perm = await DeviceMotionEvent.requestPermission();
    if(perm !== 'granted'){ showToast('Permission denied'); return; }
  }
  window.addEventListener('deviceorientation', handleOrientation);
  showToast('Sensors enabled');
});

// Set zero
document.getElementById('btnSetZero').addEventListener('click', ()=>{
  zeroOffset = currentAngle;
  maxAngle = currentAngle;
  minAngle = currentAngle;
  showToast('Zero reference set');
});

// Handle orientation
function handleOrientation(event){
  // Pitch (beta) - front/back tilt
  currentAngle = event.beta ? event.beta - zeroOffset : 0;
  document.getElementById('angleDisplay').innerText = currentAngle.toFixed(1);

  if(currentAngle > maxAngle) maxAngle = currentAngle;
  if(currentAngle < minAngle) minAngle = currentAngle;
  document.getElementById('maxDisplay').innerText = maxAngle.toFixed(1);
  document.getElementById('minDisplay').innerText = minAngle.toFixed(1);
}

// Session control
document.getElementById('btnStart').addEventListener('click', ()=>{
  let intervalSec = parseFloat(document.getElementById('autoInterval').value);
  if(isNaN(intervalSec) || intervalSec <=0){ showToast('Invalid interval'); return; }

  if(sessionInterval) clearInterval(sessionInterval);
  sessionInterval = setInterval(()=>{
    let record = {
      time: new Date().toLocaleString(),
      joint: document.getElementById('jointSelect').value,
      angle: currentAngle.toFixed(1)
    };
    records.push(record);
    localStorage.setItem('records', JSON.stringify(records));
    updateTable();
  }, intervalSec*1000);

  showToast('Session started');
});

document.getElementById('btnStop').addEventListener('click', ()=>{
  if(sessionInterval){ clearInterval(sessionInterval); sessionInterval=null; showToast('Session stopped'); }
});

// Update table
function updateTable(){
  const tbody = document.querySelector('#recordsTable tbody');
  tbody.innerHTML = '';
  records.forEach(r=>{
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.time}</td><td>${r.joint}</td><td>${r.angle}</td>`;
    tbody.appendChild(tr);
  });
}

// Export CSV
document.getElementById('btnExport').addEventListener('click', ()=>{
  if(records.length===0){ showToast('No records'); return; }
  let csv = 'Time,Joint,Angle°\n' + records.map(r=>`${r.time},${r.joint},${r.angle}`).join('\n');
  let blob = new Blob([csv],{type:'text/csv'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url; a.download='records.csv'; a.click();
  URL.revokeObjectURL(url);
});

// Copy to clipboard
document.getElementById('btnCopy').addEventListener('click', ()=>{
  if(records.length===0){ showToast('No records'); return; }
  let csv = 'Time,Joint,Angle°\n' + records.map(r=>`${r.time},${r.joint},${r.angle}`).join('\n');
  navigator.clipboard.writeText(csv).then(()=>showToast('Records copied'));
});
</script>
</body>
</html>
