<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ROM Tracker – YouMOVE</title>
<style>
  :root { --bg:#0b1016; --card:#121820; --muted:#8aa0b2; --text:#eaf2f8; --accent:#50c878; --danger:#ff6b6b; --warn:#ffc857; }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#0b1016,#0e141c);color:var(--text)}
  .wrap{max-width:960px;margin:0 auto;padding:16px 14px 40px}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 14px}
  h1{font-size:22px;margin:0}
  .card{background:var(--card);border:1px solid #1d2732;border-radius:18px;padding:14px;margin:10px 0;box-shadow:0 6px 24px rgba(0,0,0,.28)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select, button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #203040;background:#0b1118;color:var(--text);font-size:15px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{cursor:pointer;transition:transform .02s ease,opacity .2s}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--accent);color:#072d19;border-color:#0d5b3a;font-weight:700}
  .btn.warn{background:var(--warn);color:#432; border-color:#a77}
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
  .tile{background:#0a121a;border:1px solid #1d2a38;border-radius:16px;padding:14px;text-align:center}
  .tile h3{margin:4px 0 0;font-size:24px}
  .tile span{font-size:12px;color:var(--muted)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0f1b23;padding:10px 14px;border-radius:10px;border:1px solid #1f2f3a;box-shadow:0 6px 20px rgba(0,0,0,.4);display:none;z-index:999}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #203040;padding:6px;text-align:center;font-size:13px}
  th{background:#121820;color:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>YouMOVE – Deine Gelenkbewegung: privat, souverän und cloudfrei </h1>
    <div class="flex">
      <button id="btnEnable" class="btn primary">Enable Sensors</button>
      <button id="btnCalibrate" class="btn">Set Zero</button>
      <button id="btnResetMinMax" class="btn warn">Reset Min/Max</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label>Joint</label>
        <select id="joint">
          <option>Shoulder</option>
          <option>Elbow</option>
          <option>Wrist</option>
          <option>Hip</option>
          <option>Knee</option>
          <option>Ankle</option>
          <option>Rest</option>
        </select>
      </div>
      <div>
        <label>Plane / Movement</label>
        <select id="plane">
          <option value="beta">Flexion/Extension (β)</option>
          <option value="gamma">Abduction/Adduction (γ)</option>
          <option value="alpha">Rotation (α)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Side</label>
        <select id="side">
          <option>Right</option>
          <option>Left</option>
          <option>Midline</option>
        </select>
      </div>
      <div>
        <label>Notes (optional)</label>
        <input id="notes" type="text" placeholder="e.g., post-op wk 2">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="tile"><span>Angle (°)</span><h3 id="angle">—</h3></div>
      <div class="tile"><span>Max (°)</span><h3 id="max">—</h3></div>
      <div class="tile"><span>Min (°)</span><h3 id="min">—</h3></div>
      <div class="tile"><span>Zero Ref (°)</span><h3 id="zero">—</h3></div>
      <div class="tile"><span>Mean (°)</span><h3 id="mean">—</h3></div>
      <div class="tile"><span>Joint / Rest</span><h3 id="jointRest">—</h3></div>
    </div>
    <div class="flex" style="margin-top:10px;">
      <button id="btnStart" class="btn primary">Start Session</button>
      <button id="btnStop" class="btn warn">Stop</button>
      <span class="pill right" id="sensorStatus">Sensors: idle</span>
    </div>
  </div>

  <!-- Live Chart -->
  <div class="card">
    <strong>Live Session Chart</strong>
    <canvas id="liveChart" style="width:100%;height:200px;margin-top:8px;"></canvas>
    <div class="hint">Live angles with mean (dashed line)</div>
  </div>

  <!-- Saved session table -->
  <div class="card">
    <strong>Saved Sessions</strong>
    <button id="btnExport" class="btn primary" style="margin-top:6px;">Export CSV</button>
    <table>
      <thead>
        <tr><th>Timestamp</th><th>Joint</th><th>Plane</th><th>Side</th><th>Angle (°)</th><th>Mean (°)</th></tr>
      </thead>
      <tbody id="savedSessions"></tbody>
    </table>
  </div>

  <!-- Disclaimer -->
  <div class="card">
    <p class="muted small">
      <strong>Disclaimer:</strong> This tool is intended for screening, exercise guidance, and documentation support. It does not replace clinical judgment or certified goniometry where required.<br><br>
      <strong>Intellectual Property:</strong> The software, design, code, and all algorithms are the intellectual property of Moustafa Mohammed Elsayed Ali and are protected by copyright and patent law. Any reproduction, distribution, or commercial use without explicit written permission is prohibited.<br><br>
      <strong>Contact:</strong> Moustafa Mohammed Elsayed Ali<br>
      Adresse: Kronwittener Straße 1, 84367 Tann, Germany<br>
      Telefon: +49 1522 5321568<br>
      E-Mail: <a href="mailto:mostischmidbauer@web.de">mostischmidbauer@web.de</a> | <a href="mailto:dptmostafa@gmail.com">dptmostafa@gmail.com</a><br>
      LinkedIn: <a href="https://www.linkedin.com/in/moustafa-ali-024471aa/" target="_blank">https://www.linkedin.com/in/moustafa-ali-024471aa/</a>
    </p>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const ui = {
    angle: document.getElementById('angle'),
    min: document.getElementById('min'),
    max: document.getElementById('max'),
    zero: document.getElementById('zero'),
    mean: document.getElementById('mean'),
    jointRest: document.getElementById('jointRest'),
    sensorStatus: document.getElementById('sensorStatus'),
    btnEnable: document.getElementById('btnEnable'),
    btnCalibrate: document.getElementById('btnCalibrate'),
    btnResetMinMax: document.getElementById('btnResetMinMax'),
    btnStart: document.getElementById('btnStart'),
    btnStop: document.getElementById('btnStop'),
    joint: document.getElementById('joint'),
    plane: document.getElementById('plane'),
    side: document.getElementById('side'),
    notes: document.getElementById('notes'),
    savedSessions: document.getElementById('savedSessions'),
    btnExport: document.getElementById('btnExport'),
    toast: document.getElementById('toast')
  };

  let running=false, zero=0, min=Infinity, max=-Infinity, currentAngle=0, listenerAdded=false;
  let sessionSamples=[];
  let autoSaveInterval=null;

  function showToast(txt, ms=1200){ ui.toast.textContent=txt; ui.toast.style.display='block'; setTimeout(()=>ui.toast.style.display='none', ms); }

  function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }

  async function enableSensors(){
    try{
      if(isIOS() && typeof DeviceMotionEvent.requestPermission==='function'){
        const res = await DeviceMotionEvent.requestPermission();
        if(res!=='granted') throw new Error('Permission denied');
      }
      if(!listenerAdded){
        window.addEventListener('deviceorientation', onOrient, true);
        listenerAdded=true;
      }
      ui.sensorStatus.textContent='Sensors: ready';
      showToast('Sensors enabled');
    }catch{
      ui.sensorStatus.textContent='Sensors: blocked';
      showToast('Permission denied, use fallback');
    }
  }

  function getAxisAngle(alpha,beta,gamma,plane){
    switch(plane){
      case 'alpha': return ((alpha+540)%360)-180;
      case 'beta': return beta;
      case 'gamma': return gamma;
      default: return 0;
    }
  }

  function onOrient(e){
    if(!running) return;
    const a=e.alpha||0, b=e.beta||0, g=e.gamma||0;
    const raw = getAxisAngle(a,b,g,ui.plane.value)-zero;
    currentAngle = ((raw+180)%360)-180;
    if(currentAngle>max) max=currentAngle;
    if(currentAngle<min) min=currentAngle;
    sessionSamples.push(currentAngle);
    updateKPI();
    updateLiveChart();
  }

  function updateKPI(){
    ui.angle.textContent = currentAngle.toFixed(1);
    ui.min.textContent = isFinite(min)?min.toFixed(1):'—';
    ui.max.textContent = isFinite(max)?max.toFixed(1):'—';
    ui.zero.textContent = zero.toFixed(1);
    const mean = sessionSamples.length ? sessionSamples.reduce((a,b)=>a+b,0)/sessionSamples.length : 0;
    ui.mean.textContent = sessionSamples.length?mean.toFixed(1):'—';
    ui.jointRest.textContent = ui.joint.value.includes('Rest') ? 'Rest':'Active';
  }

  ui.btnEnable.addEventListener('click', enableSensors);
  ui.btnStart.addEventListener('click', ()=>{
    if(!listenerAdded) enableSensors();
    running=true;
    showToast('Session started');
    autoSaveInterval = setInterval(autoSave, 20000);
  });
  ui.btnStop.addEventListener('click', ()=>{
    running=false;
    showToast('Session stopped');
    clearInterval(autoSaveInterval);
  });
  ui.btnResetMinMax.addEventListener('click', ()=>{ min=Infinity; max=-Infinity; updateKPI(); showToast('Min/Max reset'); });
  ui.btnCalibrate.addEventListener('click', ()=>{ zero=currentAngle; updateKPI(); showToast('Zero set'); });

  // Chart.js setup
  const ctx = document.getElementById('liveChart').getContext('2d');
  const liveChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label:'Angle (°)', data:[], borderColor:'#50c878', backgroundColor:'rgba(80,200,120,0.1)', tension:0.2 },
        { label:'Mean', data:[], borderColor:'#ffc857', borderDash:[5,5], fill:false, pointRadius:0, tension:0 }
      ]
    },
    options:{
      animation:false,
      responsive:true,
      plugins:{ legend:{ display:true } },
      scales:{
        x:{ type:'time', time:{ unit:'second', tooltipFormat:'HH:mm:ss' } },
        y:{ beginAtZero:true }
      }
    }
  });

  function updateLiveChart(){
    if(!sessionSamples.length) return;
    const now = new Date();
    const labels = sessionSamples.map((_,i)=>new Date(now.getTime()-(sessionSamples.length-i-1)*1000));
    const data = sessionSamples.slice();
    const mean = data.reduce((a,b)=>a+b,0)/data.length;
    const meanLine = Array(data.length).fill(mean);

    liveChart.data.labels = labels;
    liveChart.data.datasets[0].data = data;
    liveChart.data.datasets[1].data = meanLine;
    liveChart.update();
  }

  function autoSave(){
    if(!sessionSamples.length) return;
    const mean = sessionSamples.reduce((a,b)=>a+b,0)/sessionSamples.length;
    const row = document.createElement('tr');
    const ts = new Date().toLocaleTimeString();
    row.innerHTML = `<td>${ts}</td><td>${ui.joint.value}</td><td>${ui.plane.value}</td><td>${ui.side.value}</td><td>${currentAngle.toFixed(1)}</td><td>${mean.toFixed(1)}</td>`;
    ui.savedSessions.appendChild(row);
    sessionSamples=[]; // reset session buffer
  }

  ui.btnExport.addEventListener('click', ()=>{
    let csv='Timestamp,Joint,Plane,Side,Angle,Mean\n';
    ui.savedSessions.querySelectorAll('tr').forEach(r=>{
      const cells = Array.from(r.children).map(c=>c.textContent);
      csv+=cells.join(',')+'\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='sessions.csv'; a.click();
    URL.revokeObjectURL(url);
  });

})();
</script>
</body>
</html>

