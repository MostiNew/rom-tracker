<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>YouMOVE – Deine Gelenkbewegung: privat, offline und vollkommen cloudfrei</title>
<style>
:root { --bg:#0b1016; --card:#121820; --muted:#8aa0b2; --text:#eaf2f8; --accent:#50c878; --warn:#ffc857; }
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;}
body{background:linear-gradient(180deg,#0b1016,#0e141c);color:var(--text);line-height:1.4;}
.wrap{max-width:960px;margin:0 auto;padding:16px 14px 40px;}
header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 14px}
h1{font-size:20px;margin:0;}
.card{background:var(--card);border:1px solid #1d2732;border-radius:18px;padding:14px;margin:10px 0;box-shadow:0 6px 24px rgba(0,0,0,.28);}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
select, button{width:100%;padding:10px;border-radius:12px;border:1px solid #203040;background:#0b1118;color:var(--text);font-size:15px;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.btn{cursor:pointer;transition:transform .02s ease,opacity .2s;}
.btn:active{transform:scale(.98);}
.btn.primary{background:var(--accent);color:#072d19;border-color:#0d5b3a;font-weight:700;}
.btn.warn{background:var(--warn);color:#432;border-color:#a77;}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:10px;}
.tile{background:#0a121a;border:1px solid #1d2a38;border-radius:16px;padding:14px;text-align:center;}
.tile h3{margin:4px 0 0;font-size:24px;}
.tile span{font-size:12px;color:var(--muted);}
canvas{width:100%!important;height:180px!important;display:block;}
.table-container{overflow-x:auto;}
table{width:100%;color:#eaf2f8;border-collapse:collapse;}
th, td{padding:6px;text-align:center;border-bottom:1px solid #203040;font-size:13px;}
th{color:var(--muted);}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0f1b23;padding:10px 14px;border-radius:10px;border:1px solid #1f2f3a;box-shadow:0 6px 20px rgba(0,0,0,.4);display:none;z-index:999}
@media(max-width:600px){.row{grid-template-columns:1fr;}}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
</head>
<body>
<div class="wrap">
<header>
<h1>YouMOVE – Deine Gelenkbewegung: privat, offline und vollkommen cloudfrei</h1>
<div class="flex">
  <button id="btnEnable" class="btn primary">Enable Sensors</button>
  <button id="btnCalibrate" class="btn">Set Zero</button>
  <button id="btnResetMinMax" class="btn">Reset Min/Max</button>
</div>
</header>

<div class="card">
  <div class="row">
    <div>
      <label>Joint</label>
      <select id="joint">
        <option>Shoulder</option>
        <option>Elbow</option>
        <option>Wrist</option>
        <option>Hip</option>
        <option>Knee</option>
        <option>Ankle</option>
        <option>Rest</option>
      </select>
    </div>
    <div>
      <label>Plane / Movement</label>
      <select id="plane">
        <option value="beta">Flexion/Extension (β)</option>
        <option value="gamma">Abduction/Adduction (γ)</option>
        <option value="alpha">Rotation (α)</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Side</label>
      <select id="side">
        <option>Right</option>
        <option>Left</option>
        <option>Midline</option>
      </select>
    </div>
    <div>
      <label>TTS Language</label>
      <select id="ttsLang">
        <option value="en-US">English</option>
        <option value="de-DE">Deutsch</option>
        <option value="es-ES">Español</option>
      </select>
    </div>
  </div>
</div>

<div class="card">
  <div class="kpi">
    <div class="tile"><span>Angle (°)</span><h3 id="angle">—</h3></div>
    <div class="tile"><span>Max (°)</span><h3 id="max">—</h3></div>
    <div class="tile"><span>Min (°)</span><h3 id="min">—</h3></div>
    <div class="tile"><span>Zero Ref (°)</span><h3 id="zero">—</h3></div>
    <div class="tile"><span>Mean (°)</span><h3 id="mean">—</h3></div>
    <div class="tile"><span>Joint / Rest</span><h3 id="jointRest">—</h3></div>
  </div>
  <div style="margin-top:10px;">
    <button id="btnStart" class="btn primary">Start</button>
    <button id="btnStop" class="btn warn">Stop</button>
    <button id="btnExport" class="btn">Export CSV</button>
    <span id="sensorStatus" class="tile" style="padding:6px;">Sensors: idle</span>
  </div>
</div>

<div class="card">
  <canvas id="liveChart"></canvas>
</div>

<div class="card table-container">
  <table id="savedSessions">
    <thead>
      <tr>
        <th>Timestamp</th><th>Joint</th><th>Plane</th><th>Side</th><th>Angle</th><th>Mean</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
<p style="color:var(--muted);font-size:12px;">
  <strong>Disclaimer:</strong> This tool is intended for screening, exercise guidance, and documentation support. It does not replace clinical judgment or certified goniometry where required.<br><br>
  <strong>Intellectual Property:</strong> The software, design, code, and all algorithms are the intellectual property of Moustafa Mohammed Elsayed Ali and are protected by copyright and patent law. Any reproduction, distribution, or commercial use without explicit written permission is prohibited.<br><br>
  <strong>Contact:</strong> Moustafa Mohammed Elsayed Ali<br>
  Adresse: Kronwittener Straße 1, 84367 Tann, Germany<br>
  Telefon: +49 1522 5321568<br>
  E-Mail: <a href="mailto:mostischmidbauer@web.de">mostischmidbauer@web.de</a> | <a href="mailto:dptmostafa@gmail.com">dptmostafa@gmail.com</a><br>
  LinkedIn: <a href="https://www.linkedin.com/in/moustafa-ali-024471aa/" target="_blank">https://www.linkedin.com/in/moustafa-ali-024471aa/</a>
</p>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  const ui = {
    angle: document.getElementById('angle'),
    min: document.getElementById('min'),
    max: document.getElementById('max'),
    zero: document.getElementById('zero'),
    mean: document.getElementById('mean'),
    jointRest: document.getElementById('jointRest'),
    sensorStatus: document.getElementById('sensorStatus'),
    btnEnable: document.getElementById('btnEnable'),
    btnCalibrate: document.getElementById('btnCalibrate'),
    btnResetMinMax: document.getElementById('btnResetMinMax'),
    btnStart: document.getElementById('btnStart'),
    btnStop: document.getElementById('btnStop'),
    btnExport: document.getElementById('btnExport'),
    joint: document.getElementById('joint'),
    plane: document.getElementById('plane'),
    side: document.getElementById('side'),
    ttsLang: document.getElementById('ttsLang'),
    savedSessions: document.querySelector('#savedSessions tbody'),
    toast: document.getElementById('toast')
  };

  let running=false, zero=0, min=Infinity, max=-Infinity, currentAngle=0, listenerAdded=false;
  let sessionSamples=[], chartData=[]; 
  let autoSaveInterval=null;
  const liveWindowSec=30;
  let ttsUtterance=null;

  const ctx = document.getElementById('liveChart').getContext('2d');
  const liveChart = new Chart(ctx,{
    type:'line',
    data:{ labels:[], datasets:[
      {label:'Angle (°)', data:[], borderColor:'#50c878', backgroundColor:'rgba(80,200,120,0.1)', tension:0.2},
      {label:'Mean', data:[], borderColor:'#ffc857', borderDash:[5,5], fill:false, pointRadius:0, tension:0}
    ]},
    options:{animation:false,responsive:true,maintainAspectRatio:false,scales:{x:{type:'time',time:{tooltipFormat:'YYYY-MM-DD HH:mm:ss',unit:'second'}},y:{beginAtZero:true}}}
  });

  function showToast(txt, ms=1500){ ui.toast.textContent=txt; ui.toast.style.display='block'; setTimeout(()=>{ui.toast.style.display='none';}, ms); }

  function enableSensors(){
    if(!window.DeviceOrientationEvent){ ui.sensorStatus.textContent='Not supported'; showToast('Device orientation not supported'); return;}
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(p=>{
        if(p==='granted') startSensorListener(); 
        else { ui.sensorStatus.textContent='Blocked'; showToast('Permission denied'); }
      }).catch(()=>{ ui.sensorStatus.textContent='Blocked'; showToast('Permission denied'); });
    } else startSensorListener();
  }

  function startSensorListener(){
    if(listenerAdded) return;
    window.addEventListener('deviceorientation', e=>{
      if(!running) return;
      const a=e.alpha||0,b=e.beta||0,g=e.gamma||0;
      const val = getAngle(a,b,g,ui.plane.value)-zero;
      const angleVal = ((val+180)%360)-180;
      if(isNaN(angleVal)) return;
      currentAngle = angleVal;
      if(currentAngle>max) max=currentAngle;
      if(currentAngle<min) min=currentAngle;
      const now = new Date();
      sessionSamples.push({time:now,value:currentAngle});
      chartData.push({time:now,value:currentAngle});
      updateKPI();
      updateChart();
    }, true);
    listenerAdded=true;
    ui.sensorStatus.textContent='Sensors ready';
    showToast('Sensors enabled');
  }

  function getAngle(a,b,g,plane){ switch(plane){ case'alpha':return ((a+540)%360)-180; case'beta':return b; case'gamma':return g; default:return 0; } }

  function updateKPI(){
    ui.angle.textContent=currentAngle.toFixed(1);
    ui.min.textContent=isFinite(min)?min.toFixed(1):'—';
    ui.max.textContent=isFinite(max)?max.toFixed(1):'—';
    ui.zero.textContent=zero.toFixed(1);
    const mean = sessionSamples.filter(s=>!isNaN(s.value)).reduce((a,b)=>a+b.value,0) / (sessionSamples.filter(s=>!isNaN(s.value)).length || 1);
    ui.mean.textContent=mean.toFixed(1);
    ui.jointRest.textContent = ui.joint.value.includes('Rest') ? 'Rest':'Active';
  }

  function updateChart(){
    const now=new Date();
    const windowStart=new Date(now.getTime()-liveWindowSec*1000);
    const visible=chartData.filter(s=>s.time>=windowStart);
    liveChart.data.labels=visible.map(s=>s.time);
    const values=visible.map(s=>s.value);
    const meanVal=values.length ? values.reduce((a,b)=>a+b,0)/values.length : 0;
    liveChart.data.datasets[0].data=values;
    liveChart.data.datasets[1].data=Array(values.length).fill(meanVal);
    liveChart.update();
  }

  function autoSave(){
    if(!sessionSamples.length) return;
    const validSamples = sessionSamples.filter(s=>!isNaN(s.value));
    if(!validSamples.length) return;

    const mean = validSamples.reduce((a,b)=>a+b.value,0)/validSamples.length;
    const last = validSamples[validSamples.length-1];
    const row = document.createElement('tr');
    row.innerHTML = `<td>${last.time.toLocaleString()}</td><td>${ui.joint.value}</td><td>${ui.plane.value}</td><td>${ui.side.value}</td><td>${last.value.toFixed(1)}</td><td>${mean.toFixed(1)}</td>`;
    ui.savedSessions.appendChild(row);

    // TTS
    if(window.speechSynthesis && running){
      if(ttsUtterance) window.speechSynthesis.cancel();
      ttsUtterance = new SpeechSynthesisUtterance(`Angle: ${last.value.toFixed(1)} degrees`);
      ttsUtterance.lang = ui.ttsLang.value || 'en-US';
      ttsUtterance.volume = 0.5;
      ttsUtterance.rate = 0.9;
      window.speechSynthesis.speak(ttsUtterance);
    }

    sessionSamples=[]; // clear buffer
    updateKPI(); // recalc mean from empty buffer => mean remains last captured
  }

  ui.btnEnable.addEventListener('click', enableSensors);
  ui.btnStart.addEventListener('click', ()=>{
    if(!listenerAdded){ showToast('Enable sensors first'); return; }
    running=true;
    ui.sensorStatus.textContent='Session running';
    autoSaveInterval=setInterval(autoSave,20000);
  });
  ui.btnStop.addEventListener('click', ()=>{
    running=false;
    ui.sensorStatus.textContent='Session stopped';
    clearInterval(autoSaveInterval);
  });
  ui.btnCalibrate.addEventListener('click', ()=>{ zero=currentAngle; updateKPI(); showToast('Zero set'); });
  ui.btnResetMinMax.addEventListener('click', ()=>{ min=Infinity; max=-Infinity; updateKPI(); showToast('Min/Max reset'); });

  ui.btnExport.addEventListener('click', ()=>{
    let csv='Timestamp,Joint,Plane,Side,Angle,Mean\n';
    ui.savedSessions.querySelectorAll('tr').forEach(r=>{csv+=Array.from(r.children).map(c=>c.textContent).join(',')+'\n';});
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='sessions.csv'; a.click();
    URL.revokeObjectURL(url);
  });

})();
</script>
</body>
</html>
