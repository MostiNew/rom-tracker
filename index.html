<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ROM Tracker – YouMOVE</title>
<style>
:root { --bg:#0b1016; --card:#121820; --muted:#8aa0b2; --text:#eaf2f8; --accent:#50c878; --warn:#ffc857; }
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
body{margin:0;background:linear-gradient(180deg,#0b1016,#0e141c);color:var(--text)}
.wrap{max-width:960px;margin:0 auto;padding:16px 14px 40px}
header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 14px}
h1{font-size:22px;margin:0}
.card{background:var(--card);border:1px solid #1d2732;border-radius:18px;padding:14px;margin:10px 0;box-shadow:0 6px 24px rgba(0,0,0,.28)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
select, button{width:100%;padding:12px;border-radius:12px;border:1px solid #203040;background:#0b1118;color:var(--text);font-size:15px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{cursor:pointer;transition:transform .02s ease,opacity .2s}
.btn:active{transform:scale(.98)}
.btn.primary{background:var(--accent);color:#072d19;border-color:#0d5b3a;font-weight:700}
.btn.warn{background:var(--warn);color:#432; border-color:#a77}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
.tile{background:#0a121a;border:1px solid #1d2a38;border-radius:16px;padding:14px;text-align:center}
.tile h3{margin:4px 0 0;font-size:24px}
.tile span{font-size:12px;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0f1b23;padding:10px 14px;border-radius:10px;border:1px solid #1f2f3a;box-shadow:0 6px 20px rgba(0,0,0,.4);display:none;z-index:999}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>YouMOVE – Deine Gelenkbewegung: privat, souverän und cloudfre</h1>
    <div class="flex">
      <button id="btnEnable" class="btn primary">Enable Sensors</button>
      <button id="btnCalibrate" class="btn">Set Zero</button>
      <button id="btnResetMinMax" class="btn">Reset Min/Max</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <label>Joint</label>
        <select id="joint">
          <option>Shoulder</option>
          <option>Elbow</option>
          <option>Wrist</option>
          <option>Hip</option>
          <option>Knee</option>
          <option>Ankle</option>
          <option>Rest</option>
        </select>
      </div>
      <div>
        <label>Plane / Movement</label>
        <select id="plane">
          <option value="beta">Flexion/Extension (β)</option>
          <option value="gamma">Abduction/Adduction (γ)</option>
          <option value="alpha">Rotation (α)</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div>
        <label>Side</label>
        <select id="side">
          <option>Right</option>
          <option>Left</option>
          <option>Midline</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="tile"><span>Angle (°)</span><h3 id="angle">—</h3></div>
      <div class="tile"><span>Max (°)</span><h3 id="max">—</h3></div>
      <div class="tile"><span>Min (°)</span><h3 id="min">—</h3></div>
      <div class="tile"><span>Zero Ref (°)</span><h3 id="zero">—</h3></div>
      <div class="tile"><span>Mean (°)</span><h3 id="mean">—</h3></div>
      <div class="tile"><span>Joint / Rest</span><h3 id="jointRest">—</h3></div>
    </div>
    <div style="margin-top:10px;">
      <button id="btnStart" class="btn primary">Start</button>
      <button id="btnStop" class="btn warn">Stop</button>
      <button id="btnExport" class="btn">Export CSV</button>
      <span id="sensorStatus" class="tile" style="padding:6px;">Sensors: idle</span>
    </div>
  </div>

  <div class="card">
    <canvas id="liveChart" height="120"></canvas>
  </div>

  <div class="card">
    <table style="width:100%;color:#eaf2f8;border-collapse:collapse;" id="savedSessions">
      <thead>
        <tr>
          <th>Timestamp</th><th>Joint</th><th>Plane</th><th>Side</th><th>Angle</th><th>Mean</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <p style="color:var(--muted);font-size:12px;">
      <strong>Disclaimer:</strong> This tool is intended for screening, exercise guidance, and documentation support. It does not replace clinical judgment or certified goniometry.<br><br>
      <strong>Intellectual Property:</strong> Software and code are property of Moustafa Mohammed Elsayed Ali.<br>
      <strong>Contact:</strong> <a href="mailto:mostischmidbauer@web.de">mostischmidbauer@web.de</a> | <a href="mailto:dptmostafa@gmail.com">dptmostafa@gmail.com</a>
    </p>
  </div>
</div>

<script>
(function(){
  const ui = {
    angle: document.getElementById('angle'),
    min: document.getElementById('min'),
    max: document.getElementById('max'),
    zero: document.getElementById('zero'),
    mean: document.getElementById('mean'),
    jointRest: document.getElementById('jointRest'),
    sensorStatus: document.getElementById('sensorStatus'),
    btnEnable: document.getElementById('btnEnable'),
    btnCalibrate: document.getElementById('btnCalibrate'),
    btnResetMinMax: document.getElementById('btnResetMinMax'),
    btnStart: document.getElementById('btnStart'),
    btnStop: document.getElementById('btnStop'),
    btnExport: document.getElementById('btnExport'),
    joint: document.getElementById('joint'),
    plane: document.getElementById('plane'),
    side: document.getElementById('side'),
    savedSessions: document.querySelector('#savedSessions tbody'),
    toast: document.getElementById('toast')
  };

  let running=false, zero=0, min=Infinity, max=-Infinity, currentAngle=0, listenerAdded=false;
  let sessionSamples=[];
  let autoSaveInterval=null;
  const liveWindowSec=30;

  // Chart.js setup
  const ctx = document.getElementById('liveChart').getContext('2d');
  const liveChart = new Chart(ctx,{
    type:'line',
    data:{
      labels:[],
      datasets:[
        {label:'Angle (°)', data:[], borderColor:'#50c878', backgroundColor:'rgba(80,200,120,0.1)', tension:0.2},
        {label:'Mean', data:[], borderColor:'#ffc857', borderDash:[5,5], fill:false, pointRadius:0, tension:0}
      ]
    },
    options:{
      animation:false,
      responsive:true,
      scales:{ x:{ type:'time', time:{ tooltipFormat:'HH:mm:ss' } }, y:{ beginAtZero:true } }
    }
  });

  function showToast(txt, ms=1200){ alert(txt); } // can improve with styled toast later

  function enableSensors(){
    if(window.DeviceOrientationEvent){
      if(typeof DeviceOrientationEvent.requestPermission==='function'){
        DeviceOrientationEvent.requestPermission().then(p=>{
          if(p==='granted') startSensorListener();
          else ui.sensorStatus.textContent='Sensors blocked';
        }).catch(()=>ui.sensorStatus.textContent='Sensors blocked');
      }else startSensorListener();
    }else ui.sensorStatus.textContent='Sensors not supported';
  }

  function startSensorListener(){
    if(!listenerAdded){
      window.addEventListener('deviceorientation', e=>{
        if(!running) return;
        const alpha=e.alpha||0, beta=e.beta||0, gamma=e.gamma||0;
        const val = getAngle(alpha,beta,gamma,ui.plane.value)-zero;
        currentAngle = ((val+180)%360)-180;
        if(currentAngle>max) max=currentAngle;
        if(currentAngle<min) min=currentAngle;
        sessionSamples.push({time:new Date(), value:currentAngle});
        updateKPI();
        updateChart();
      }, true);
      listenerAdded=true;
      ui.sensorStatus.textContent='Sensors ready';
    }
  }

  function getAngle(a,b,g,plane){ switch(plane){ case'alpha':return ((a+540)%360)-180; case'beta':return b; case'gamma':return g; default:return 0; } }

  function updateKPI(){
    ui.angle.textContent=currentAngle.toFixed(1);
    ui.min.textContent=isFinite(min)?min.toFixed(1):'—';
    ui.max.textContent=isFinite(max)?max.toFixed(1):'—';
    ui.zero.textContent=zero.toFixed(1);
    const mean=sessionSamples.length?sessionSamples.reduce((a,b)=>a.value+b.value,0)/sessionSamples.length:0;
    ui.mean.textContent=sessionSamples.length?mean.toFixed(1):'—';
    ui.jointRest.textContent=ui.joint.value.includes('Rest')?'Rest':'Active';
  }

  function updateChart(){
    const now=new Date();
    const windowStart=new Date(now.getTime()-liveWindowSec*1000);
    const visible=sessionSamples.filter(s=>s.time>=windowStart);
    liveChart.data.labels=visible.map(s=>s.time);
    const values=visible.map(s=>s.value);
    const meanVal=values.length?values.reduce((a,b)=>a+b,0)/values.length:0;
    liveChart.data.datasets[0].data=values;
    liveChart.data.datasets[1].data=Array(values.length).fill(meanVal);
    liveChart.update();
  }

  function autoSave(){
    if(!sessionSamples.length) return;
    const mean=sessionSamples.reduce((a,b)=>a.value+b.value,0)/sessionSamples.length;
    const last=sessionSamples[sessionSamples.length-1];
    const row=document.createElement('tr');
    row.innerHTML=`<td>${last.time.toLocaleTimeString()}</td><td>${ui.joint.value}</td><td>${ui.plane.value}</td><td>${ui.side.value}</td><td>${last.value.toFixed(1)}</td><td>${mean.toFixed(1)}</td>`;
    ui.savedSessions.appendChild(row);
    sessionSamples=[]; // clear buffer for next auto-save
  }

  ui.btnEnable.addEventListener('click', enableSensors);
  ui.btnStart.addEventListener('click', ()=>{
    running=true;
    ui.sensorStatus.textContent='Session running';
    autoSaveInterval=setInterval(autoSave,20000);
  });
  ui.btnStop.addEventListener('click', ()=>{
    running=false;
    ui.sensorStatus.textContent='Session stopped';
    clearInterval(autoSaveInterval);
  });
  ui.btnCalibrate.addEventListener('click', ()=>{ zero=currentAngle; updateKPI(); });
  ui.btnResetMinMax.addEventListener('click', ()=>{ min=Infinity; max=-Infinity; updateKPI(); });

  ui.btnExport.addEventListener('click', ()=>{
    let csv='Timestamp,Joint,Plane,Side,Angle,Mean\n';
    ui.savedSessions.querySelectorAll('tr').forEach(r=>{
      const cells=Array.from(r.children).map(c=>c.textContent);
      csv+=cells.join(',')+'\n';
    });
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='sessions.csv'; a.click();
    URL.revokeObjectURL(url);
  });

})();
</script>
</body>
</html>
